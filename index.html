<!DOCTYPE html>
<html>
  <head>
    <title>Data Layer: Styling</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;
      function initMap() {
        // map정의
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {lat: 36, lng: 128}
        });
        // infoWindow정의

        // Load GeoJSON.
        map.data.loadGeoJson('/api/loc'); // 측정소 정보 GeoJson 로드
        map.data.setStyle(function(feature) {
  		  return {
  		    //icon: gradeToMarker(feature.getProperty('pm10grade')), // pm10단계값에 따라 마커 색상 결정
          icon: pm10LevelToMarker(feature.getProperty('pm10value')),   // pm10 값에 따라 마커 색상 조절
          visible: true,
  		    clickable: true,
          title: feature.getProperty('stationName') + ": " + feature.getProperty('pm10value')// 롤오버 텍스트
  		    };
  		   });

       // Geolocation
       if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            //infoWindow.setPosition(pos);
            //infoWindow.setContent('You\'re here now');
            //infoWindow.open(map);
            // 현재 위치 마커
            myloc = new google.maps.Marker({position: pos, map: map, draggable: true, icon: "https://maps.gstatic.com/mapfiles/ms2/micons/pink-dot.png", title: "You\'re here!"});
            map.panTo(pos);
            map.setZoom(11);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }// initMap

      // Geolocation Error
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }

      // http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=7|FF0000|000000

      function pm10LevelToMarker(pm10Level) {
        var red = 0;
        var blue = 0;
        var green = 0;
        var err = false;

        // 00FFFF (0, cyan) - 00FF00 (40, green) - FF8000 (80, Orange) - 800000 (200, Maroon)
        if (pm10Level > 200) { red = 128; }
        else if (pm10Level > 80) { red = 255 - (pm10Level - 80) * 127 / 120; green = red + 127 }
        else if (pm10Level > 40) { red = (pm10Level - 40) * 255 / 40; green = 255 - red / 2 }
        else if (pm10Level > 0) { blue = (40 - pm10Level) * 255 / 50; green = 255 }
        else { err = true; }

        if (err) { return "https://maps.gstatic.com/mapfiles/ms2/micons/mechanic.png" }
        else { return "https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=" + parseInt(pm10Level / 10) + "|" + make2digit(parseInt(red).toString(16)) + make2digit(parseInt(green).toString(16)) + make2digit(parseInt(blue).toString(16)) + "|000000" }
      }

      function make2digit(hex) {
        hex = hex + '';
        if (hex.length == 1) { return '0' + hex; }
        else return hex;
      }

      // 미세먼지 등급별 마커 소스 링크
      function gradeToMarker(grade) {
        if (grade == 1) { return "https://maps.gstatic.com/mapfiles/ms2/micons/blue.png"}
        else if (grade == 2) { return "https://maps.gstatic.com/mapfiles/ms2/micons/green.png"}
        else if (grade == 3) { return "https://maps.gstatic.com/mapfiles/ms2/micons/yellow.png"}
        else if (grade == 4) { return "https://maps.gstatic.com/mapfiles/ms2/micons/red.png"}
        else { return "https://maps.gstatic.com/mapfiles/ms2/micons/mechanic.png"}
      }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdCL-n84xXzrtOjRXSkL5QCAfXC_FMigM&callback=initMap">
    </script>
  </body>
</html>
